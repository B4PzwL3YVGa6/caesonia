# $OpenBSD: httpd.conf,v 1.16 2016/09/17 20:05:59 tj Exp $

#
# Macros
#

IPv4="*"
IPv6="::"

#
# Global Options
#

prefork 1

#
# Servers
#

# Host:443
server "mercury.example.com" {
	alias "autoconfig.example.com"

	listen on $IPv4 tls port https
	listen on $IPv6 tls port https

	hsts subdomains

	tls certificate "/etc/ssl/acme/mercury.example.com.fullchain.pem"
	tls key "/etc/ssl/acme/private/mercury.example.com.key"
	# (!) see usr/local/bin/get-ocsp.sh
	tls ocsp "/etc/ssl/acme/mercury.example.com.ocsp.resp.der"

	# Cipher Strength <https://h3artbl33d.nl/tech/httpd-tls.html>
	tls ciphers "ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA"
	# Key Exchange
	tls dhe "auto"
	tls ecdhe "P-384"

	tcp nodelay
	connection { max requests 500, timeout 3600 }

	log { access "access.log", error "error.log" }

	block

	location "/*" {
		root "/htdocs/mercury.example.com"
		pass
	}
}

# Host:80
server "mercury.example.com" {
	listen on $IPv4 port http
	listen on $IPv6 port http

	tcp nodelay
	connection { max requests 500, timeout 3600 }

	log { access "access.log", error "error.log" }

	block

	location "/.well-known/acme-challenge/*" {
		root "/acme"
		root strip 2
		pass
	}

	location "/*" {
		root "/htdocs/mercury.example.com"
		pass
	}
}

# Mozilla Autoconfiguration
server "autoconfig.*" {
	listen on $IPv4 port http
	listen on $IPv6 port http

	tcp nodelay
	connection { max requests 500, timeout 3600 }

	log syslog

	block

	location "/*" {
		block return 302 "https://autoconfig.example.com$REQUEST_URI"
	}
}

# IP defender (!) must be last server
server "nonexistent" {
	alias match "%d+%.%d+%.%d+%.%d+" # IPv4 or IPv6
	alias match "%w*::*" # IPv6

	listen on $IPv4 port http
	listen on $IPv4 port https # (!) no tls
	listen on $IPv6 port http
	listen on $IPv6 port https # (!) no tls

	tcp nodelay
	connection { max requests 500, timeout 3600 }

	log syslog

	block # nothing to see here

	root "/nonexistent"
	directory no index
}

#
# Include MIME types instead of the built-in ones
#

types {
	include "/usr/share/misc/mime.types"
}
